{% extends "base.html" %}
{% block title %}Lista de Pessoas{% endblock %}

{% block dashboard %}
<div class="container mt-4">
  <h2>Pessoas</h2>

  <!-- Bot√£o para abrir formul√°rio -->
  <button class="btn btn-primary mb-3" onclick="toggleForm()">+ Nova Pessoa</button>

  <!-- Formul√°rio de cadastro -->
  <div id="formPessoa" class="card p-3 mb-4 d-none">
    <h4>Cadastrar Pessoa</h4>
    <input type="text" id="nome" class="form-control mb-2" placeholder="Nome completo">
    <input type="email" id="email" class="form-control mb-2" placeholder="E-mail">
    <input type="text" id="cpf" class="form-control mb-2" placeholder="CPF">
    <input type="password" id="senha" class="form-control mb-2" placeholder="Senha">
    <select id="tipo_acesso" class="form-control mb-2">
      <option value="SECRETARIA">Secretaria</option>
      <option value="FUNCIONARIO">Funcion√°rio</option>
      <option value="ADMINISTRADOR">Administrador</option>
    </select>
    <button class="btn btn-success" onclick="adicionarPessoa()">Salvar</button>
  </div>

  <!-- Tabela -->
  <table class="table table-bordered">
    <thead>
      <tr><th>Nome</th><th>Email</th><th>CPF</th><th>Acesso</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="tabela-pessoas">
      <tr><td colspan="5">Carregando...</td></tr>
    </tbody>
  </table>
</div>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // üö® Bloqueia acesso se n√£o houver token
  const token = localStorage.getItem("access");
  if (!token) {
    window.location.href = "/login/";
  }

  // Mostra/esconde formul√°rio
  function toggleForm() {
    document.getElementById("formPessoa").classList.toggle("d-none");
  }

  // Carregar lista de pessoas
  async function carregarPessoas() {
    try {
      const resp = await axios.get("/pessoas/api/", {
        headers: { "Authorization": "Bearer " + token }
      });

      const tbody = document.getElementById("tabela-pessoas");
      tbody.innerHTML = "";
      resp.data.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.nome}</td>
            <td>${p.email}</td>
            <td>${p.cpf}</td>
            <td>${p.tipo_acesso}</td>
            <td>
              <a href="/pessoas/editar/${p.id}/" class="btn btn-warning btn-sm">Editar</a>
              <button onclick="excluirPessoa(${p.id})" class="btn btn-danger btn-sm">Excluir</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      console.error(err);
      if (err.response && err.response.status === 401) {
        alert("Sess√£o expirada. Fa√ßa login novamente.");
        localStorage.clear();
        window.location.href = "/login/";
      }
    }
  }

  // Adicionar pessoa
  async function adicionarPessoa() {
    const novaPessoa = {
      nome: document.getElementById("nome").value,
      email: document.getElementById("email").value,
      cpf: document.getElementById("cpf").value,
      senha: document.getElementById("senha").value,
      tipo_acesso: document.getElementById("tipo_acesso").value
    };

    try {
      await axios.post("/pessoas/api/adicionar/", novaPessoa, {
        headers: { "Authorization": "Bearer " + token }
      });
      alert("Pessoa cadastrada!");
      toggleForm();
      carregarPessoas();
    } catch (err) {
      console.error(err);
      alert("Erro ao cadastrar pessoa");
    }
  }

  // Excluir pessoa
  async function excluirPessoa(id) {
    if (!confirm("Deseja excluir esta pessoa?")) return;
    try {
      await axios.delete(`/pessoas/api/excluir/${id}/`, {
        headers: { "Authorization": "Bearer " + token }
      });
      alert("Pessoa exclu√≠da!");
      carregarPessoas();
    } catch (err) {
      console.error(err);
      alert("Erro ao excluir pessoa");
    }
  }

  // Inicializa
  carregarPessoas();
</script>
{% endblock %}
